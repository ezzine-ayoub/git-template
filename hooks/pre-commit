#!/usr/bin/env bash
# pre-commit hook - runs before each commit
# Ensures code quality and validates configuration
# Compatible with Windows Git Bash, WSL, and Unix systems

# Source shared functions
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/shared-functions.sh"

PROJECT_NAME=$(get_project_name)
OS_TYPE=$(detect_os)

print_header "Pre-Commit Hook"
print_info "Running on $OS_TYPE"
print_info "Project: $PROJECT_NAME"

# Check if pre-commit configuration is valid
if ! check_precommit_config; then
    print_error "Pre-commit configuration check failed"
    print_info "Please fix your .pre-commit-config.yaml file before committing"
    exit 1
fi

# Ensure Python dependencies and install hooks if needed
if ensure_python_deps && install_precommit; then
    # Run pre-commit checks
    print_info "Running pre-commit checks..."
    if run_precommit; then
        print_success "All pre-commit checks passed!"
        exit 0
    else
        print_error "Commit blocked due to pre-commit hook failures"
        print_info "Fix the issues above before committing"
        print_info "Or use 'git commit --no-verify' to bypass hooks (not recommended)"
        exit 1
    fi
else
    print_error "pre-commit not installed or configured properly"
    print_info "Please run: pip install pre-commit && pre-commit install"
    exit 1
fi
